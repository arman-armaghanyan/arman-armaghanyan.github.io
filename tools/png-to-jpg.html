<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNG to JPG - Toolity</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Import Bricolage Grotesque font */
        @import url('https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;500;600;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Bricolage Grotesque', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            overflow-x: hidden;
        }
        
        @media (max-width: 768px) {
            /* Ensure buttons are properly sized */
            #download-btn, #quality-btn, #clear-btn, #add-more-btn {
                padding: 8px;
                white-space: nowrap;
            }
        }
    </style>
</head>

<body>
    <div class="page-container" id="page-container">
        <!-- Drop indicator for full-page drop -->
        <div class="drop-indicator">
            <i class="fas fa-cloud-upload-alt" style="font-size: 64px; margin-bottom: 16px;"></i>
            <h2>Drop PNG files here to convert</h2>
            <p>Maximum 100 files</p>
        </div>
        
        <!-- Comparison Popup -->
        <div class="comparison-popup" id="comparison-popup">
            <div class="comparison-popup-header">
                <h2 class="comparison-popup-title" id="comparison-popup-title">Image Comparison</h2>
                <button class="comparison-popup-close" id="comparison-popup-close">×</button>
            </div>
            <div class="comparison-popup-content">
                <div class="comparison-image-container" id="comparison-container">
                    <img class="comparison-image" id="comparison-after" src="" alt="JPEG preview">
                    <div class="comparison-before" id="comparison-before-container">
                        <img id="comparison-before" src="" alt="PNG original">
                    </div>
                    <div class="comparison-separator" id="comparison-separator"></div>
                    <div class="comparison-handle" id="comparison-handle"></div>
                </div>
            </div>
            <div class="comparison-popup-controls">
                <div class="comparison-quality-control">
                    <label for="comparison-quality-slider">Quality:</label>
                    <input type="range" id="comparison-quality-slider" min="1" max="100" value="80">
                    <input type="number" id="comparison-quality-number" min="1" max="100" value="80">
                </div>
            </div>
        </div>
        
        <!-- Mobile Header -->
        <div class="mobile-header">
            <button class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <a href="../index.html">
                <h1>Toolity</h1>
            </a>
        </div>
        
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <a href="../index.html">
                    <h1>Toolity</h1>
                </a>
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-tools">
                <!-- Tool links will be generated dynamically -->
            </div>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="tool-section">
                <div class="tool-header">
                    <i class="fas fa-file-image"></i>
                    <h1>PNG to JPG</h1>
                </div>

                <!-- Updated header actions with plus button -->
                <div class="header-actions" id="header-actions" style="display: none;">
                    <button class="tool-button" id="download-btn">
                        <i class="fas fa-download"></i>
                        <span>Download All</span>
                    </button>
                    <button class="tool-button" id="add-more-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="tool-button" id="quality-btn">
                        <i class="fas fa-sliders-h"></i>
                    </button>
                    <button class="tool-button" id="clear-btn">
                        <i class="fas fa-trash"></i>
                        <span>Clear All</span>
                    </button>
                </div>

                <div class="tool-container">
                    <!-- Tool specific content goes here -->
                    <div id="initial-state">
                    <div class="tool-dropzone" id="dropzone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drag and drop your PNG files here or click to browse</p>
                        <p>Maximum 100 files, PNG format only</p>
                        <input type="file" id="file-input" multiple accept=".png" style="display: none;">
                        </div>
                    </div>

                    <div id="processing-state" style="display: none;">
                        <!-- Processing state will be shown here -->
                        <div class="tool-actions-container">
                            <div class="empty-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Processing your images...</p>
                            </div>
                        </div>
                    </div>

                    <div id="converted-state" style="display: none;">
                        <div class="tool-actions-container">
                            
                            <div class="converted-grid" id="converted-grid">
                                <!-- Converted images will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Updated quality dialog -->
            <div class="quality-dialog" id="quality-dialog">
                <div class="quality-dialog-content">
                    <div class="quality-dialog-header">
                        <h3>Image Quality Settings</h3>
                        <button class="quality-dialog-close" id="quality-dialog-close">×</button>
                    </div>
                    <div class="quality-dialog-body">
                        <p>Adjust the quality of selected images. Lower quality means smaller file size.</p>
                        <div class="quality-dialog-range">
                            <div class="quality-dialog-range-input">
                                <input type="range" id="quality-slider" min="1" max="100" value="80">
                                <input type="number" id="quality-number" min="1" max="100" value="80">
                            </div>
                        </div>
                    </div>
                    <div class="quality-dialog-footer">
                        <button class="tool-button secondary" id="quality-cancel-btn">Cancel</button>
                        <button class="tool-button" id="quality-apply-btn">Apply</button>
                    </div>
                </div>
            </div>

            <div class="tool-section">
                <h2>How to Use</h2>
                <p>1. Upload your PNG files by dragging them anywhere on the page or clicking the upload area<br>
                   2. Select images by clicking on them<br>
                   3. Adjust quality settings if needed<br>
                   4. Download selected images or all converted images with the download button</p>
            </div>

            <!-- <div class="tool-section">
                <h2>About PNG to JPG</h2>
                <p>This tool allows you to quickly convert PNG images to JPEG format. While PNG files support
                    transparency and lossless compression, JPG files are typically smaller and better suited for
                    photographs or web images where transparency isn't needed. You can control the quality of the output
                    JPG files to balance between file size and image quality.</p>
            </div> -->

            <div>
                <div class="similar-tools-grid">
                    <!-- Similar tools will be generated dynamically -->
                </div>
            </div>
        </main>
    </div>

    <script src="../js/presets.js"></script>
    <script src="../js/image-comparison.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Generate sidebar tools
            const sidebarTools = document.querySelector('.sidebar-tools');
            const currentToolName = document.title.split(' - ')[0];

            TOOL_PRESETS.tools.forEach(tool => {
                const toolElement = document.createElement(tool.isLocked ? 'div' : 'a');
                toolElement.className = 'sidebar-tool';

                // Add active class if this is the current tool
                if (tool.name === currentToolName) {
                    toolElement.classList.add('active');
                }

                // Add locked attribute if tool is locked
                if (tool.isLocked) {
                    toolElement.setAttribute('locked', '');
                } else {
                    toolElement.href = "../" + tool.url;
                }

                // Add new attribute if tool is new
                if (tool.isNew) {
                    toolElement.setAttribute('new', '');
                }

                toolElement.innerHTML = `
                    <i class="fas ${tool.icon}"></i>
                    <h3>${tool.name}</h3>
                `;
                sidebarTools.appendChild(toolElement);
            });

            // Generate similar tools
            const similarToolsGrid = document.querySelector('.similar-tools-grid');
            const currentTool = TOOL_PRESETS.tools.find(t => t.name === currentToolName);

            if (currentTool) {
                // Get tools from the same category
                const similarTools = TOOL_PRESETS.tools
                    .filter(t => t.category === currentTool.category && t.name !== currentToolName)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3);

                similarTools.forEach(tool => {
                    const toolElement = document.createElement(tool.isLocked ? 'div' : 'a');
                    toolElement.className = 'similar-tool';

                    if (!tool.isLocked) {
                        toolElement.href = "../" + tool.url;
                    }

                    if (tool.isLocked) {
                        toolElement.setAttribute('locked', '');
                    }

                    if (tool.isNew) {
                        toolElement.setAttribute('new', '');
                    }

                    toolElement.innerHTML = `
                        <i class="fas ${tool.icon}"></i>
                        <h3>${tool.name}</h3>
                        <p>${tool.description}</p>
                        ${tool.isNew ? '<span class="new-badge">New</span>' : ''}
                    `;

                    similarToolsGrid.appendChild(toolElement);
                });
            }

            // PNG to JPG converter functionality
            const pageContainer = document.getElementById('page-container');
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.getElementById('file-input');
            const initialState = document.getElementById('initial-state');
            const processingState = document.getElementById('processing-state');
            const convertedState = document.getElementById('converted-state');
            const convertedGrid = document.getElementById('converted-grid');
            const headerActions = document.getElementById('header-actions');
            const downloadBtn = document.getElementById('download-btn');
            const addMoreBtn = document.getElementById('add-more-btn');
            const qualityBtn = document.getElementById('quality-btn');
            const clearBtn = document.getElementById('clear-btn');
            
            // Quality dialog elements
            const qualityDialog = document.getElementById('quality-dialog');
            const qualitySlider = document.getElementById('quality-slider');
            const qualityNumber = document.getElementById('quality-number');
            const qualityCancelBtn = document.getElementById('quality-cancel-btn');
            const qualityApplyBtn = document.getElementById('quality-apply-btn');
            const qualityDialogClose = document.getElementById('quality-dialog-close');

            let convertedFiles = [];
            let selectedFiles = new Set();
            const MAX_FILES = 100;
            let defaultQuality = 80;

            // Initialize the image comparison component
            ImageComparison.init({
                onQualityChange: function(quality, data) {
                    if (data && data.id) {
                        const fileIndex = convertedFiles.findIndex(file => file.id === data.id);
                        if (fileIndex !== -1) {
                            const file = convertedFiles[fileIndex];
                            file.quality = quality;
                            
                            // Re-convert the image with new quality
                            const img = new Image();
                            img.onload = function() {
                                convertImage(img, file);
                                
                                // Update the comparison popup with the new image
                                if (file.dataUrl) {
                                    ImageComparison.updateAfterImage(file.dataUrl);
                                }
                            };
                            
                            img.src = file.originalDataUrl;
                        }
                    }
                }
            });

            // Handle file selection
            function handleFiles(files) {
                // Filter for PNG files only
                const pngFiles = Array.from(files).filter(file => file.type === 'image/png');

                if (pngFiles.length === 0) {
                    // Create and show error message
                    showErrorMessage('Please select valid PNG files');
                    return;
                }
                
                // Check if we're exceeding the maximum number of files
                if (convertedFiles.length + pngFiles.length > MAX_FILES) {
                    showErrorMessage(`You can only convert up to ${MAX_FILES} files at once.`);
                    return;
                }
                
                // Process files
                const filesToProcess = pngFiles.slice(0, MAX_FILES - convertedFiles.length);

                // Show processing state
                initialState.style.display = 'none';
                processingState.style.display = 'block';
                convertedState.style.display = 'none';
                
                // Show action buttons
                headerActions.style.display = 'flex';

                // Process each file
                filesToProcess.forEach(file => {
                    processFile(file);
                });
                
                // Setup mobile interactions for any new items
                setTimeout(setupMobileInteractions, 100);
            }
            
            // Function to show error message
            function showErrorMessage(message) {
                // Check if error message element already exists
                let errorEl = document.getElementById('error-message');
                
                // Create it if it doesn't exist
                if (!errorEl) {
                    errorEl = document.createElement('div');
                    errorEl.id = 'error-message';
                    
                    // Add close button
                    const closeBtn = document.createElement('button');
                    closeBtn.innerHTML = '&times;';
                    closeBtn.onclick = function() {
                        errorEl.style.display = 'none';
                    };
                    
                    errorEl.appendChild(closeBtn);
                    
                    // Insert at the top of the tool container
                    const toolContainer = document.querySelector('.tool-container');
                    toolContainer.insertBefore(errorEl, toolContainer.firstChild);
                } else {
                    // Reset display if it was hidden
                    errorEl.style.display = 'block';
                }
                
                // Add message text element
                const textSpan = document.createElement('span');
                textSpan.textContent = message;
                
                // Clear any previous message
                if (errorEl.querySelector('span')) {
                    errorEl.querySelector('span').remove();
                }
                
                // Add after the close button
                errorEl.appendChild(textSpan);
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 5000);
            }

            // Process a single file
            function processFile(file) {
                    const reader = new FileReader();
                
                // Create a placeholder for this file
                const fileId = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const convertedFile = {
                    id: fileId,
                    originalName: file.name,
                    jpegName: file.name.replace('.png', '.jpg'),
                    originalSize: file.size,
                    convertedSize: 0,
                    quality: defaultQuality,
                    dataUrl: null,
                    progress: 0,
                    originalDataUrl: null
                };
                
                convertedFiles.push(convertedFile);
                
                // Add to grid with progress animation
                addFileToGrid(convertedFile);
                
                // Show converted state
                initialState.style.display = 'none';
                processingState.style.display = 'none';
                convertedState.style.display = 'block';
                
                // Simulate progress updates
                simulateProgress(fileId);

                    reader.onload = function (e) {
                        const img = new Image();
                    
                    // Store original data URL for quality adjustments
                    convertedFile.originalDataUrl = e.target.result;
                    
                        img.onload = function () {
                        // Convert the image once it's loaded
                        convertImage(img, convertedFile);
                    };
                    
                    img.src = e.target.result;
                };
                
                reader.readAsDataURL(file);
            }
            
            // Simulate progress updates
            function simulateProgress(fileId) {
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 10;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                    }
                    
                    updateProgress(fileId, progress);
                }, 100);
            }
            
            // Update progress display
            function updateProgress(fileId, progress) {
                const fileIndex = convertedFiles.findIndex(file => file.id === fileId);
                if (fileIndex !== -1) {
                    convertedFiles[fileIndex].progress = progress;
                    
                    const progressBar = document.querySelector(`.converted-item[data-id="${fileId}"] .converted-item-progress`);
                    const progressText = document.querySelector(`.converted-item[data-id="${fileId}"] .converted-item-progress-text`);
                    
                    if (progressBar && progressText) {
                        progressBar.style.width = `${progress}%`;
                        progressText.textContent = `${Math.round(progress)}%`;
                        
                        // Hide progress elements when complete
                        if (progress >= 100) {
                            setTimeout(() => {
                                progressBar.style.display = 'none';
                                progressText.style.display = 'none';
                            }, 300);
                        }
                    }
                }
            }
            
            // Convert image to JPEG
            function convertImage(img, file) {
                            // Create canvas for conversion
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;

                            const ctx = canvas.getContext('2d');
                            // Fill with white background to replace transparency
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0);

                            // Convert to JPEG
                const jpegDataUrl = canvas.toDataURL('image/jpeg', file.quality / 100);
                
                // Update file info
                const fileIndex = convertedFiles.findIndex(f => f.id === file.id);
                if (fileIndex !== -1) {
                    convertedFiles[fileIndex].dataUrl = jpegDataUrl;
                    convertedFiles[fileIndex].convertedSize = Math.round(jpegDataUrl.length * 0.75);
                    convertedFiles[fileIndex].progress = 100;
                    
                    // Update the preview image
                    updateFilePreview(file.id, jpegDataUrl);
                    updateFileInfo(file.id);
                }
            }
            
            // Set up event listeners for mobile and touch devices
            function setupMobileInteractions() {
                // Make sure selection works well on touch devices
                document.querySelectorAll('.converted-item').forEach(item => {
                    // Skip if already initialized
                    if (item.hasAttribute('touch-initialized')) return;
                    
                    item.setAttribute('touch-initialized', 'true');
                    
                    item.addEventListener('touchstart', function(e) {
                        // Add a small delay to differentiate between tap and scroll
                        this.touchStarted = Date.now();
                    }, { passive: true });
                    
                    item.addEventListener('touchend', function(e) {
                        // If touch duration was short, treat as a tap
                        const touchDuration = Date.now() - (this.touchStarted || 0);
                        if (touchDuration < 300) {
                            const fileId = this.dataset.id;
                            toggleFileSelection(fileId);
                            e.preventDefault();
                        }
                    });
                });
                
                // Better handling of buttons for touch
                document.querySelectorAll('.tool-button').forEach(button => {
                    // Skip if already initialized
                    if (button.hasAttribute('touch-initialized')) return;
                    
                    button.setAttribute('touch-initialized', 'true');
                    
                    button.addEventListener('touchstart', function() {
                        this.classList.add('active');
                    }, { passive: true });
                    
                    button.addEventListener('touchend', function() {
                        this.classList.remove('active');
                    });
                });
                
                // Ensure dropzone works well on mobile
                if (!dropzone.hasAttribute('touch-initialized')) {
                    dropzone.setAttribute('touch-initialized', 'true');
                    
                    dropzone.addEventListener('touchend', function(e) {
                        fileInput.click();
                        e.preventDefault();
                    });
                }
            }

            // Add file to grid initially with progress bar
            function addFileToGrid(file) {
                const item = document.createElement('div');
                item.className = 'converted-item';
                item.dataset.id = file.id;
                
                // Split filename and extension
                const nameParts = splitFilename(file.jpegName);

                item.innerHTML = `
                    <div class="converted-item-select" data-id="${file.id}">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                    </div>
                    <div class="converted-item-preview">
                        <div class="converted-item-progress" style="width: 0%"></div>
                        <div class="converted-item-progress-text">0%</div>
                        <img src="" alt="${file.jpegName}" style="display: none;">
                    </div>
                    <div class="converted-item-info">
                        <div class="converted-item-filename">
                            <span class="filename-name">${nameParts.name}</span>
                            <span class="filename-ext">.${nameParts.ext}</span>
                    </div>
                        <div class="converted-item-size">
                            <span>${formatFileSize(file.originalSize)}</span>
                            <span>→</span>
                            <span>Processing...</span>
                        </div>
                    </div>
                `;

                convertedGrid.appendChild(item);
                
                // Add click event to select the item
                item.addEventListener('click', () => {
                    toggleFileSelection(file.id);
                });
                
                // Add double-click event to open comparison popup
                item.addEventListener('dblclick', () => {
                    openComparisonPopup(file.id);
                });
                
                // Add touch events for mobile
                item.addEventListener('touchstart', function(e) {
                    this.touchStarted = Date.now();
                }, { passive: true });
                
                item.addEventListener('touchend', function(e) {
                    const touchDuration = Date.now() - (this.touchStarted || 0);
                    if (touchDuration < 300) {
                        const fileId = this.dataset.id;
                        toggleFileSelection(fileId);
                        e.preventDefault();
                    }
                });
                
                // Add click event for the select icon
                const selectIcon = item.querySelector('.converted-item-select');
                selectIcon.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent the parent click from triggering
                    toggleFileSelection(file.id);
                });
            }
            
            // Update file preview with the converted image
            function updateFilePreview(fileId, dataUrl) {
                const preview = document.querySelector(`.converted-item[data-id="${fileId}"] .converted-item-preview img`);
                if (preview) {
                    preview.src = dataUrl;
                    preview.style.display = 'block';
                }
            }
            
            // Update file info with converted size
            function updateFileInfo(fileId) {
                const file = convertedFiles.find(f => f.id === fileId);
                if (!file) return;
                
                const infoElement = document.querySelector(`.converted-item[data-id="${fileId}"] .converted-item-size`);
                if (infoElement) {
                    infoElement.innerHTML = `
                        <span>${formatFileSize(file.originalSize)}</span>
                        <span>→</span>
                        <span>${formatFileSize(file.convertedSize)}</span>
                    `;
                }
            }
            
            // Toggle file selection
            function toggleFileSelection(fileId) {
                const itemElement = document.querySelector(`.converted-item[data-id="${fileId}"]`);
                const isCurrentlySelected = selectedFiles.has(fileId);
                
                if (isCurrentlySelected) {
                    selectedFiles.delete(fileId);
                    itemElement.classList.remove('selected');
                } else {
                    selectedFiles.add(fileId);
                    itemElement.classList.add('selected');
                }
                
                // Update download button text based on selection
                updateDownloadButton();
            }
            
            // Update download button text based on selection
            function updateDownloadButton() {
                const count = selectedFiles.size;
                const downloadBtnSpan = downloadBtn.querySelector('span');
                const clearBtnSpan = clearBtn.querySelector('span');
                
                if (count === 0) {
                    downloadBtnSpan.textContent = 'Download All';
                    clearBtnSpan.textContent = 'Clear All';
                } else if (count === 1) {
                    downloadBtnSpan.textContent = 'Download Selected';
                    clearBtnSpan.textContent = 'Remove Selected';
                } else {
                    downloadBtnSpan.textContent = `Download ${count} Selected`;
                    clearBtnSpan.textContent = `Remove ${count} Selected`;
                }
            }
            
            // Format file size
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }
            
            // Split filename into name and extension
            function splitFilename(filename) {
                const parts = filename.split('.');
                const ext = parts.pop();
                const name = parts.join('.');
                return { name, ext };
            }
            
            // Handle download button click
            function handleDownload() {
                if (selectedFiles.size > 0) {
                    // Download selected files
                    downloadSelectedFiles();
                } else {
                    // Download all files
                    downloadAllFiles();
                }
            }
            
            // Download selected files
            function downloadSelectedFiles() {
                if (selectedFiles.size === 0) return;
                
                selectedFiles.forEach(fileId => {
                    const file = convertedFiles.find(f => f.id === fileId);
                    if (file && file.dataUrl) {
                        downloadFile(file);
                    }
                });
            }

            // Download all files
            function downloadAllFiles() {
                if (convertedFiles.length === 0) return;
                
                // Filter for files that have completed conversion
                const completedFiles = convertedFiles.filter(file => file.dataUrl);

                // Use setTimeout to avoid browser blocking multiple downloads
                completedFiles.forEach((file, index) => {
                    setTimeout(() => {
                        downloadFile(file);
                    }, index * 100);
                });
            }
            
            // Download a specific file
            function downloadFile(file) {
                const link = document.createElement('a');
                link.href = file.dataUrl;
                link.download = file.jpegName;
                link.click();
            }
            
            // Adjust quality of selected files
            function showQualityDialog() {
                // Use selected files if there are any, otherwise all files
                const targetFiles = selectedFiles.size > 0 
                    ? Array.from(selectedFiles).map(id => convertedFiles.find(f => f.id === id)).filter(Boolean)
                    : convertedFiles;
                
                if (targetFiles.length === 0) return;
                
                // Calculate average quality
                const avgQuality = Math.round(
                    targetFiles.reduce((sum, file) => sum + file.quality, 0) / targetFiles.length
                );
                
                // Set dialog values
                qualitySlider.value = avgQuality;
                qualityNumber.value = avgQuality;
                
                // Show dialog
                qualityDialog.classList.add('active');
            }
            
            // Comparison popup functionality
            const comparisonPopup = document.getElementById('comparison-popup');
            const comparisonPopupTitle = document.getElementById('comparison-popup-title');
            const comparisonPopupClose = document.getElementById('comparison-popup-close');
            const comparisonContainer = document.getElementById('comparison-container');
            const comparisonBeforeContainer = document.getElementById('comparison-before-container');
            const comparisonSeparator = document.getElementById('comparison-separator');
            const comparisonHandle = document.getElementById('comparison-handle');
            const comparisonBefore = document.getElementById('comparison-before');
            const comparisonAfter = document.getElementById('comparison-after');
            const comparisonQualitySlider = document.getElementById('comparison-quality-slider');
            const comparisonQualityNumber = document.getElementById('comparison-quality-number');
            
            let currentComparisonFile = null;
            
            // Open comparison popup for a file
            function openComparisonPopup(fileId) {
                const file = convertedFiles.find(f => f.id === fileId);
                if (!file || !file.dataUrl || !file.originalDataUrl) return;
                
                ImageComparison.open({
                    id: file.id,
                    title: file.jpegName,
                    beforeSrc: file.originalDataUrl,
                    afterSrc: file.dataUrl,
                    quality: file.quality
                });
            }
            
            // Set comparison position by percentage (0-100)
            function setComparisonPosition(percent) {
                comparisonBeforeContainer.style.width = `${percent}%`;
                comparisonSeparator.style.left = `${percent}%`;
                comparisonHandle.style.left = `${percent}%`;
            }
            
            // Close comparison popup
            function closeComparisonPopup() {
                comparisonPopup.classList.remove('active');
                currentComparisonFile = null;
            }
            
            // Initialize comparison slider functionality
            function initComparisonSlider() {
                // Already handled by the ImageComparison component
            }
            
            // Apply quality from comparison popup
            function applyComparisonQuality() {
                // Already handled by the ImageComparison component
            }
            
            // Event listeners for comparison popup
            comparisonPopupClose.addEventListener('click', closeComparisonPopup);
            comparisonQualitySlider.addEventListener('input', function() {
                comparisonQualityNumber.value = this.value;
            });
            
            comparisonQualityNumber.addEventListener('input', function() {
                comparisonQualitySlider.value = this.value;
            });
            
            comparisonQualitySlider.addEventListener('change', applyComparisonQuality);
            comparisonQualityNumber.addEventListener('change', applyComparisonQuality);
            
            // Apply quality settings to files
            function applyQuality() {
                const quality = parseInt(qualitySlider.value);
                
                // Apply to selected files if there are any, otherwise all files
                const targetFileIds = selectedFiles.size > 0 
                    ? Array.from(selectedFiles)
                    : convertedFiles.map(file => file.id);
                
                targetFileIds.forEach(fileId => {
                    const fileIndex = convertedFiles.findIndex(file => file.id === fileId);
                    if (fileIndex !== -1) {
                        const file = convertedFiles[fileIndex];
                        file.quality = quality;
                        
                        // Re-convert the image with new quality
                        const img = new Image();
                        img.onload = function() {
                            convertImage(img, file);
                        };
                        
                        // Create a data URL from the original image
                        img.src = file.originalDataUrl;
                    }
                });
                
                hideQualityDialog();
            }
            
            // Hide quality dialog
            function hideQualityDialog() {
                qualityDialog.classList.remove('active');
            }

            // Clear all files
            function clearAllFiles() {
                if (selectedFiles.size > 0) {
                    // Remove only selected files
                    Array.from(selectedFiles).forEach(fileId => {
                        const fileIndex = convertedFiles.findIndex(file => file.id === fileId);
                        if (fileIndex !== -1) {
                            // Free memory by revoking data URLs
                            if (fileIndex !== -1 && convertedFiles[fileIndex].dataUrl) {
                                // URL.revokeObjectURL is not needed for data URLs,
                                // but we should remove the reference to let garbage collection happen
                                convertedFiles[fileIndex].dataUrl = null;
                                convertedFiles[fileIndex].originalDataUrl = null;
                            }
                            
                            // Remove the element from DOM
                            const fileElement = document.querySelector(`.converted-item[data-id="${fileId}"]`);
                            if (fileElement) {
                                fileElement.remove();
                            }
                            
                            // Remove from array
                            convertedFiles.splice(fileIndex, 1);
                        }
                    });
                    
                    // Clear selection
                    selectedFiles.clear();
                    
                    // Update download button
                    updateDownloadButton();
                    
                    // Show initial state if no files left
                    if (convertedFiles.length === 0) {
                        initialState.style.display = 'block';
                        convertedState.style.display = 'none';
                        headerActions.style.display = 'none';
                    }
                } else {
                    // Clear all files
                    convertedFiles = [];
                    selectedFiles.clear();
                    convertedGrid.innerHTML = '';
                    initialState.style.display = 'block';
                    convertedState.style.display = 'none';
                    headerActions.style.display = 'none';
                    updateDownloadButton();
                }
            }
            
            // Global drag and drop handling
            function setupGlobalDragDrop() {
                const dragCounter = (() => {
                    let counter = 0;
                    return {
                        increase: () => ++counter,
                        decrease: () => --counter,
                        reset: () => { counter = 0; },
                        get: () => counter
                    };
                })();
                
                // Prevent default on all drag events to allow drop
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    document.addEventListener(eventName, e => {
                        e.preventDefault();
                        e.stopPropagation();
                    }, false);
                });
                
                // Track drag enter/leave events with counter to handle child elements
                document.addEventListener('dragenter', e => {
                    dragCounter.increase();
                    pageContainer.classList.add('dragover');
                }, false);
                
                document.addEventListener('dragleave', e => {
                    if (dragCounter.decrease() === 0) {
                        pageContainer.classList.remove('dragover');
                    }
                }, false);
                
                document.addEventListener('drop', e => {
                    dragCounter.reset();
                    pageContainer.classList.remove('dragover');
                    
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    
                    if (files.length > 0) {
                        // Check if at least one PNG file was dropped
                        const pngFiles = Array.from(files).filter(file => file.type === 'image/png');
                        
                        if (pngFiles.length === 0) {
                            showErrorMessage('Only PNG files are supported. Please select valid PNG files.');
                            return;
                        }
                        
                        handleFiles(files);
                    }
                }, false);
            }
            
            // Event listeners
            
            // Dropzone
            dropzone.addEventListener('click', function () {
                fileInput.click();
            });

            fileInput.addEventListener('change', function () {
                if (this.files && this.files.length > 0) {
                handleFiles(this.files);
                } else {
                    // No files selected (user canceled)
                    console.log('File selection canceled');
                }
            });

            // Action buttons
            downloadBtn.addEventListener('click', handleDownload);
            addMoreBtn.addEventListener('click', function() {
                fileInput.click();
            });
            qualityBtn.addEventListener('click', showQualityDialog);
            clearBtn.addEventListener('click', clearAllFiles);
            
            // Quality dialog
            qualitySlider.addEventListener('input', function() {
                qualityNumber.value = this.value;
            });
            
            qualityNumber.addEventListener('input', function() {
                qualitySlider.value = this.value;
            });
            
            qualityApplyBtn.addEventListener('click', applyQuality);
            qualityCancelBtn.addEventListener('click', hideQualityDialog);
            qualityDialogClose.addEventListener('click', hideQualityDialog);
            
            // Initialize
            setupGlobalDragDrop();
            setupMobileInteractions();
            updateDownloadButton();
            initComparisonSlider();
        });

        // Toggle sidebar on mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('open');
        }
        
        // Close sidebar when clicking on a link (for mobile)
        document.querySelectorAll('.sidebar-tool').forEach(link => {
            link.addEventListener('click', () => {
                const sidebar = document.querySelector('.sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                if (sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    overlay.classList.remove('open');
                }
            });
        });
    </script>
</body>

</html>